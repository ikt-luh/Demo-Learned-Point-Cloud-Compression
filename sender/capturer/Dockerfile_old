# Capturer Dockerfile
FROM dustynv/l4t-pytorch:r36.2.0

# To avoid waiting for input during package installation
ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update && apt-get install --no-install-recommends -y \
    libgl1-mesa-glx \
    libglib2.0-0 \ 
    libusb-1.0 \
    sudo \
    usbutils \
    v4l-utils \
    python3-pip
    
RUN apt -y autoremove --purge \
    python2 python2.7 python-is-python2

ARG USER_NAME=user
ARG GROUP_NAME=docker
ARG UID=1001
ARG GID=1001
    
RUN groupadd -g ${GID} ${GROUP_NAME} \
    && useradd -ms /bin/bash --uid ${UID} -g ${GID} -G sudo ${USER_NAME} \
    && echo '%sudo ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers
    
USER ${USER_NAME}

RUN sudo usermod -aG video ${USER_NAME}

# Install Python dependencies for the capturer
COPY requirements.txt /app/requirements.txt
RUN pip install --no-cache-dir -r /app/requirements.txt

# Copy application code
COPY . /app
WORKDIR /app

# Ensure the container uses GPU
ENV NVIDIA_VISIBLE_DEVICES all
ENV NVIDIA_DRIVER_CAPABILITIES compute,utility

# Entry point for the capturer
CMD ["python3", "capturer.py"]

